<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RT2_Assignment: Assignment - Research Track 2</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RT2_Assignment
   </div>
   <div id="projectbrief">The assignment deals with a robot moving into an initlially unknown enviroment. Depending on the mode selected, the robot can drive autonomously, reaching a given goal, being driven by the user and being driven by the user, assisting them to avoid collisions.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Assignment - Research Track 2 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr  />
<h1><a class="anchor" id="autotoc_md1"></a>
Introduction</h1>
<p>The final assignment deals with a robot moving into an initlially <b>unknown</b> enviroment. Depending on the mode selected, the robot can <b>drive autonomously, reaching a given goal</b>, <b>being driven by the user</b> and <b>being driven by the user, assisting them to avoid collisions</b>.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Installing and running</h1>
<p>The simulator requires <a href="http://wiki.ros.org"><b>ROS</b></a> (<b>Robot-Operating-Systems</b>) to be installed on the machine. In particular, the <a href="http://wiki.ros.org/noetic/Installation">Noetic Release of ROS</a> was used.</p>
<p>For this particular simulation there are some required elements:</p><ul>
<li><a href="https://github.com/CarmineD8/slam_gmapping">Slam Gmappic package</a></li>
<li>ros navigation stack</li>
<li>xterm</li>
</ul>
<p>If you don't have any of these elements you can run the following instructions:</p>
<div class="fragment"><div class="line">$ git clone https://github.com/CarmineD8/slam_gmapping.git</div>
</div><!-- fragment --><div class="fragment"><div class="line">$ sudo apt-get install ros-&lt;your_ros_distro&gt;-navigation</div>
</div><!-- fragment --><div class="fragment"><div class="line">$ sudo apt install xterm</div>
</div><!-- fragment --><p>After doing that, you are ready to <b>launch the simulation!</b> A launch file, called <code>launcher.launch</code>, is provided to run all the required nodes.</p>
<p>this is its structure:</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">launch</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">include</span> <span class="keyword">file</span>=<span class="stringliteral">&quot;$(find RT2_Assignment)/launch/simulation_gmapping.launch&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">include</span> <span class="keyword">file</span>=<span class="stringliteral">&quot;$(find RT2_Assignment)/launch/move_base.launch&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">node</span> <span class="keyword">pkg</span>=<span class="stringliteral">&quot;RT2_Assignment&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;mainController&quot;</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;mainController&quot;</span> <span class="keyword">output</span>=<span class="stringliteral">&quot;screen&quot;</span> <span class="keyword">required</span>=<span class="stringliteral">&quot;true&quot;</span> <span class="keyword">launch-prefix</span>=<span class="stringliteral">&quot;xterm -fa &#39;Monospace&#39; -fs 11 -e&quot;</span>/&gt;</div>
<div class="line">&lt;/<span class="keywordtype">launch</span>&gt;</div>
</div><!-- fragment --><p>Notice that <code>launch-prefix</code> of mainController node contains some rules regarding the font family and the font size, you are completely free to change it!</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Simulation environment</h1>
<p>After launching the simulation using the provided commands two programs will open, <a href="http://gazebosim.org/"><b>Gazebo</b></a> and <a href="http://wiki.ros.org/rviz"><b>Rviz</b></a>.</p>
<p>Gazebo is an open-source 3D robot simulator. Here's the simulation view from Gazebo:</p>
<p><img src="https://github.com/marcomacchia99/RT2_Assignment/blob/noetic/assets/gazebo1.jpg" alt="alt text" class="inline"/></p>
<p>ROS generate the environment based on the file <code>house.world</code>, stored into the <b>world</b> folder.</p>
<p>Initially the robot knows only what he can see, here's the image showing his initial known map.</p>
<p><img src="https://github.com/marcomacchia99/RT2_Assignment/blob/noetic/assets/rviz1.png" alt="alt text" class="inline"/></p>
<p>After some time the robot has explored and mapped all the surrounding walls using his laser scan.</p>
<p>We can now see the full map into rviz, as shown below:</p>
<p><img src="https://github.com/marcomacchia99/RT2_Assignment/blob/noetic/assets/rviz2.png" alt="alt text" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md4"></a>
MainController node</h1>
<p>The mainController node is the first node, spawned with the <code>launcher.launch</code> file. This node simply prompts some instruction in the xterm console, then it detects and interprets the user inputs.</p>
<p>The user can:</p><ul>
<li><b>1</b> - Reach autonomousely a given position</li>
<li><b>2</b> - Drive the robot with the keyboard</li>
<li><b>3</b> - Drive the robot with the keyboard with automatic collision avoidance</li>
<li><b>4</b> - Reset simulation</li>
<li><b>0</b> - Exit from the program</li>
</ul>
<p>Generally speaking, this simulation includes a non-blocking getchar function, ideal to speed up the program execution and to improve the user execution.</p>
<p>I found this function in <a href="https://github.com/methylDragon/teleop_twist_keyboard_cpp/blob/master/src/teleop_twist_keyboard.cpp">teleop_twist_keyboard_cpp repository</a>, and it temporarily edits the system settings in order to catch immediately what the user writes.</p>
<p>Remember that the <code>termios.h</code> library is required, so don't remove it!</p>
<p>Finally, based on the input received, the mainController node runs the selected node, using <code>system()</code> function.</p>
<p>For example, if the number 1 is pressed, this command is executed:</p>
<div class="fragment"><div class="line">system(<span class="stringliteral">&quot;rosrun RT2_Assignment reachPoint&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
ReachPoint node</h1>
<p>The reachPoint node implements the first required feature. In fact it set a new goal for the robot according to what the user wants.</p>
<p>At his initial state, the node request the x and y coordinates of the goal, then it generates a new message of type <code>move_base_msgs/MoveBaseActionGoal</code>. The message is then published into the <code>/move_base/goal</code> topic.</p>
<p>When the message is published, the robot starts looking for a valid path which can lead to the goal, and he followes it.</p>
<p>During the navigation, the user can at any time:</p><ul>
<li>stop the navigation by pressing the <b>q</b> key, or</li>
<li>exit the node by pressing <b>CTRL-C</b> key</li>
</ul>
<p>If one of this keys is pressed, a message of type <code>actionlib_msgs/GoalID</code> is generated and then published into the <code>/move_base/cancel</code> topic. In particular, every goal is tracked by the node with its <b>id</b>, randomly generated by the node itself using <code>rand()</code> function, so sending the goal cancel message is quite easy.</p>
<p>In order to know if the robot has reached the goal or if the robot can't reach it a <code>/move_base/status</code> message handler is implemented. It continousely checks the messages published into that topic, in particular it looks for the <b>status</b> code.</p>
<p>Initially the status code is <b>1</b>, meaning that the robot is following his path. When the robot stop there are two possibilities: if the code is equal <b>3 (succeded)</b> then it means that the goal has been successfully reached, otherwise if the robot can't reach the goal the status code will be set to <b>4 (aborted)</b>.</p>
<p>Based on the code the node displays the result in the console, then it asks if the user wants to select a new goal or exit from this node.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
DriveWithKeyboard node</h1>
<p>The driveWithKeyboard node let the user drive the robot using the keyboard.</p>
<p>Here, I decided to <b>edit the teleop_twist_keyboard</b> node, starting from the <code>.cpp</code> version which I found in the <a href="https://github.com/methylDragon/teleop_twist_keyboard_cpp/blob/master/src/teleop_twist_keyboard.cpp">teleop_twist_keyboard_cpp repository</a>.</p>
<p>In particular I clean the user interface, and I added the possibility to reset the linear and the angular speed. Also there's a new possibility to safely quit from the execution using CTRL-C combination.</p>
<p>The node simply checks the user imputs according to the instructions prompted in the console, and it publish the new speed to the <code>/cmd_vel</code> topic.</p>
<p>The speed is computed as the relative speed multiplied with the selected direction, which is an integer defined between -1 and 1. 1 means that the robot must go forward or turn left, -1 means backward (or turn right), 0 means stop.</p>
<p>Here's the computations in terms of code:</p>
<div class="fragment"><div class="line"><span class="comment">//define variables for vel direction</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="drive_with_keyboard_8cpp.html#aed6efd15a611832e8335a27a1c93795a">lin</a>=0; <span class="comment">//linear direction</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="drive_with_keyboard_8cpp.html#a4365545fd48c51e8d4fa9ebb99c6a72f">ang</a> =0; <span class="comment">//angular direction</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="drive_with_keyboard_8cpp.html#af113e9b4ca3af68972dfd3df47898c83">vel</a>.angular.z = <a class="code" href="drive_with_keyboard_8cpp.html#ae9b28d6b588b124dc762dc9a3c29619e">turn_speed</a> * <a class="code" href="drive_with_keyboard_8cpp.html#a4365545fd48c51e8d4fa9ebb99c6a72f">ang</a>;</div>
<div class="line"><a class="code" href="drive_with_keyboard_8cpp.html#af113e9b4ca3af68972dfd3df47898c83">vel</a>.linear.x = <a class="code" href="drive_with_keyboard_8cpp.html#a6dc6e6f3c75c509ce943163afb5dade7">speed</a> * <a class="code" href="drive_with_keyboard_8cpp.html#aed6efd15a611832e8335a27a1c93795a">lin</a>;</div>
</div><!-- fragment --><p>The user can use a 3x3 input keys as they are a "joystick". Here's the keys: </p><center></center><center><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter"></th><th class="markdownTableHeadCenter">Turn left </th><th class="markdownTableHeadCenter">Don't turn </th><th class="markdownTableHeadCenter">Turn right  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><b>Go forward</b> </td><td class="markdownTableBodyCenter">u </td><td class="markdownTableBodyCenter">i </td><td class="markdownTableBodyCenter">o  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"><b>Dont' go</b> </td><td class="markdownTableBodyCenter">j </td><td class="markdownTableBodyCenter">k </td><td class="markdownTableBodyCenter">l  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><b>Go backward</b> </td><td class="markdownTableBodyCenter">m </td><td class="markdownTableBodyCenter">, </td><td class="markdownTableBodyCenter">.  </td></tr>
</table>
</center><center></center><p>Also, the user can set the robot linear and angular joystick, using this set of commands:</p>
<center></center><center><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter"></th><th class="markdownTableHeadCenter">Change linear and angular </th><th class="markdownTableHeadCenter">Change linear only </th><th class="markdownTableHeadCenter">Change angular only  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><b>Increase</b> </td><td class="markdownTableBodyCenter">q </td><td class="markdownTableBodyCenter">w </td><td class="markdownTableBodyCenter">e  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter"><b>Reset</b> </td><td class="markdownTableBodyCenter">a </td><td class="markdownTableBodyCenter">s </td><td class="markdownTableBodyCenter">d  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><b>Decrease</b> </td><td class="markdownTableBodyCenter">z </td><td class="markdownTableBodyCenter">x </td><td class="markdownTableBodyCenter">c  </td></tr>
</table>
</center><center></center><h1><a class="anchor" id="autotoc_md7"></a>
DriveWithKeyboardAssisted node</h1>
<p>The driveWithKeyboardAssisted node, similar to the node above, let the user drive the robot using the keyboard, <b>assisting him during the navigation</b>.</p>
<p>In particular, the node reads the same identical user inputs as the driveWithKeyboard node, but it also checks what the robot's laser scanner sees. To do so, the node subscribes to the <code>/scan</code> topic, and it uses the message received to detect walls too close to the robot. This topic is composed by 720 <em>ranges</em>, in which there are all the detected distances. the sensor can see from -90 to 90 degrees, so each sensor has 1/4 of degree of view.</p>
<p>After a message from <code>/scan</code> is recieved, the node enters inside the <code>checkWalls</code> function, that filters all the ranges taking only the one from:</p><ul>
<li>-90° to -55° referred to the walls on the right,</li>
<li>-17.5° to 17.5° referred to the walls in front of the robot,</li>
<li>55° to 90° referred to the walls on the left.</li>
</ul>
<p>The function then checks the minimum distance inside this ranges, and if a wall is closer than <code>wall_th = 1 (meter)</code> it prevents the robot from getting too close to it. In particulat, if the front wall is too close the robot can't advance, while if one of the walls on the left or on the right is too close the robot can't turn in that direction.</p>
<p>To actuate this security feature the functions simply edits the linear and angualar direction according to the rules above, setting them to <b>0</b> when required.</p>
<p>Finally, a <b>red danger warning string</b> is prompted to the user.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Flowchart</h1>
<p>&lt;image src="https://github.com/marcomacchia99/RT1_Assignment2/blob/main/assets/diagram.png" width="600px"&gt;</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Project graph</h1>
<p>Here's the project graph which explains the relationship within the nodes. The graph can be generated using this command:</p>
<div class="fragment"><div class="line">$ rqt_graph</div>
</div><!-- fragment --><p><img src="https://github.com/marcomacchia99/RT1_Assignment2/blob/main/assets/graph.png" alt="alt text" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md10"></a>
Conclusion and future improvements</h1>
<p>By now the robot can autonomousely drive inside the <a href="https://www.monzanet.it/">Autodromo Nazionale di Monza</a>, but all the movement aren't smooth at all. A next update could introduce better movements inside the turn, expecially inside the <em>Prima variante</em>, and a bettere <em>user experience</em>.</p>
<p>It could also be possibile to dynamically change the robot speed, as the real cars actually do: The robot can drive at a speed that is inversely proportional to the amount of remaining straight. In this case however, the user input will became useless. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="adrive_with_keyboard_8cpp_html_af113e9b4ca3af68972dfd3df47898c83"><div class="ttname"><a href="drive_with_keyboard_8cpp.html#af113e9b4ca3af68972dfd3df47898c83">vel</a></div><div class="ttdeci">geometry_msgs::Twist vel</div><div class="ttdoc">velocity message</div><div class="ttdef"><b>Definition:</b> driveWithKeyboard.cpp:41</div></div>
<div class="ttc" id="adrive_with_keyboard_8cpp_html_ae9b28d6b588b124dc762dc9a3c29619e"><div class="ttname"><a href="drive_with_keyboard_8cpp.html#ae9b28d6b588b124dc762dc9a3c29619e">turn_speed</a></div><div class="ttdeci">double turn_speed</div><div class="ttdoc">robot angular speed</div><div class="ttdef"><b>Definition:</b> driveWithKeyboard.cpp:38</div></div>
<div class="ttc" id="adrive_with_keyboard_8cpp_html_aed6efd15a611832e8335a27a1c93795a"><div class="ttname"><a href="drive_with_keyboard_8cpp.html#aed6efd15a611832e8335a27a1c93795a">lin</a></div><div class="ttdeci">int lin</div><div class="ttdoc">linear robot direction</div><div class="ttdef"><b>Definition:</b> driveWithKeyboard.cpp:33</div></div>
<div class="ttc" id="adrive_with_keyboard_8cpp_html_a6dc6e6f3c75c509ce943163afb5dade7"><div class="ttname"><a href="drive_with_keyboard_8cpp.html#a6dc6e6f3c75c509ce943163afb5dade7">speed</a></div><div class="ttdeci">double speed</div><div class="ttdoc">robot linear speed</div><div class="ttdef"><b>Definition:</b> driveWithKeyboard.cpp:37</div></div>
<div class="ttc" id="adrive_with_keyboard_8cpp_html_a4365545fd48c51e8d4fa9ebb99c6a72f"><div class="ttname"><a href="drive_with_keyboard_8cpp.html#a4365545fd48c51e8d4fa9ebb99c6a72f">ang</a></div><div class="ttdeci">int ang</div><div class="ttdoc">angular robot direction</div><div class="ttdef"><b>Definition:</b> driveWithKeyboard.cpp:34</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
